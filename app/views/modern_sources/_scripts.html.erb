<script type="text/javascript">
let modernSourcesVue;
$(document).ready(function(){
	modernSourcesVue = new Vue({
		name: 'modernSourcesVue',
		el: '#modern-source-form',
		data: {
			author_type: '<%= modern_source.author_type %>',
			sources: <%= modern_source.source_urls.map{ |ms| {url: ms.url, accessed: (ms.date_accessed.present? ? format_date(ms.date_accessed) : '')} }.to_json.html_safe %>,
			source_type: '<%= modern_source.source_type %>',
			writing_system_id: '<%= modern_source.writing_system_id %>',
		},
		computed: {
			title_orig_label(){
				switch(this.source_type){
					case 'journal_article':
						return "Article title";
					case 'unpublished_document':
						return 'Document title';
					case 'web_page':
						return "Title of webpage";
					case "handwritten_document":
						return "Document title";
					case "book_chapter":
						return "Chapter title"
					default: 
						return 'Book title in original language';
				}
			},
			not_latin(){
				return this.writing_system_id != "<%= latin_writing_system_id %>" && this.source_type != "web_page"
			},
		},
		methods: {
			addUrl(){
				let vue = this;
				this.sources.push({url: '', accessed: ''});
				setTimeout(function() {
					$( ".accessed-field" ).last().datepicker({
				      changeMonth: true,
				      changeYear: true,
				      dateFormat: "d MM, yy",
				      maxDate: "+0",
				      onSelect: function() {
				      	vue.$set(vue.sources[$(this).data('index')],'accessed', $(this).val());
					    }
				    });
				}, 200);
			}
		},
		mounted(){
			let vue = this;
			runTomSelects();
			$('#modern-source-form, #page-title').removeClass('d-none');
	    $( ".accessed-field" ).datepicker({
	      changeMonth: true,
	      changeYear: true,
	      dateFormat: "d MM, yy",
	      maxDate: "+0",
	      onSelect: function() {
	      	vue.$set(vue.sources[$(this).data('index')],'accessed', $(this).val());
		    }
	    });
		},
	});
});

function runTomSelects(){
	new TomSelect("#modern_source_source_type",ts_sort_text_asc_max_1);
	new TomSelect("#author_reference_id",{
		plugins: ['caret_position'],
		optgroups: <%= @grouped_people.keys.map{ |k| { value: k, label: k.to_s.humanize } }.to_json.html_safe %>,
		items: <%= @modern_source.author_references.order(:sequence_no).map(&:person_id).to_json.html_safe %>,
		options: [
			<% sort_hash_keys(@grouped_people, ['author', 'multiple_roles', 'no_role_assigned']).each do |group, people| %>
				<% people.each do |person| %>
					{
						value: <%= person.id %>,
						text: "<%= person.full_name %>",
						group: "<%= group.to_s %>",
						sequence_no: "<%= modern_source.author_references.where(person_id: person.id).first.sequence_no if modern_source.author_references.map(&:person_id).include?(person.id) %>"
					},
				<% end %>
			<% end %>
		],
		optgroupField: "group",
		sortField: {
			field: "text",
			direction: "asc",
		},
		maxItems: null,
		hidePlaceholder: true,
		lockOptgroupOrder: true,
		maxOptions: null,
		closeAfterSelect: true,
	  onDropdownClose: function(d) {
	    $("*:focus").blur();
	  },
	  hideSelected: false,
	});
	new TomSelect("#modern_source_institution_id",ts_sort_text_asc_max_1);
	new TomSelect("#handwritten_document_institution_id",ts_sort_text_asc_max_1);
	new TomSelect("#editor_reference_id",{
		plugins: ['caret_position'],
		optgroups: <%= @grouped_people.keys.map{ |k| { value: k, label: k.to_s.humanize } }.to_json.html_safe %>,
		items: <%= @modern_source.editor_references.order(:sequence_no).map(&:person_id).to_json.html_safe %>,
		options: [
			<% sort_hash_keys(@grouped_people, ['editor', 'multiple_roles', 'no_role_assigned']).each do |group, people| %>
				<% people.each do |person| %>
					{
						value: <%= person.id %>,
						text: "<%= person.full_name %>",
						group: "<%= group.to_s %>",
						sequence_no: "<%= modern_source.editor_references.where(person_id: person.id).first.sequence_no if modern_source.editor_references.map(&:person_id).include?(person.id) %>"
					},
				<% end %>
			<% end %>
		],
		optgroupField: "group",
		sortField: {
			field: "text",
			direction: "asc",
		},
		maxItems: null,
		lockOptgroupOrder: true,
		hidePlaceholder: true,
		maxOptions: null,
		closeAfterSelect: true,
	  onDropdownClose: function(d) {
	    $("*:focus").blur();
	  },
	  hideSelected: false,
	});
	new TomSelect("#translator_reference_id",{
		plugins: ['caret_position'],
		optgroups: <%= @grouped_people.keys.map{ |k| { value: k, label: k.to_s.humanize } }.to_json.html_safe %>,
		items: <%= @modern_source.translator_references.order(:sequence_no).map(&:person_id).to_json.html_safe %>,
		options: [
			<% sort_hash_keys(@grouped_people, ['translator', 'multiple_roles', 'no_role_assigned']).each do |group, people| %>
				<% people.each do |person| %>
					{
						value: <%= person.id %>,
						text: "<%= person.full_name %>",
						group: "<%= group.to_s %>",
						sequence_no: "<%= modern_source.translator_references.where(person_id: person.id).first.sequence_no if modern_source.translator_references.map(&:person_id).include?(person.id) %>"
					},
				<% end %>
			<% end %>
		],
		optgroupField: "group",
		sortField: {
			field: "text",
			direction: "asc",
		},
		maxItems: null,
		lockOptgroupOrder: true,
		hidePlaceholder: true,
		maxOptions: null,
	  closeAfterSelect: true,
	  onDropdownClose: function(d) {
	    $("*:focus").blur();
	  },
	  hideSelected: false,
	});
	new TomSelect("#modern_source_publication_location_id",ts_sort_text_asc_max_1);
	new TomSelect("#modern_source_document_type",ts_sort_text_asc_max_1_create);
	new TomSelect("#modern_source_publisher", ts_sort_text_asc_max_1_create);
	new TomSelect("#modern_source_edition",ts_sort_text_asc_max_1_create);
	new TomSelect("#modern_source_writing_system_id",ts_sort_text_asc_max_1);
};
</script>
