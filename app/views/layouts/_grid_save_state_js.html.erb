<script type="text/javascript">

$(function() {
	setState(<%= current_user.user_grid_states.where(record_type: record_type).try(:first).try(:state).to_json.html_safe %>, <%= current_user.user_grid_states.where(record_type: record_type).try(:first).try(:filters).to_json.html_safe %>)
});

function getState(parameters) {
	$.ajax({
		url: "<%= get_user_grid_states_path %>",
		method: "GET",
		data: parameters,
		success: function(data) {
			setState(data.state, data.filters);
		}
	})
}

function restoreState() {
	getState({record_type: "<%= record_type %>"});
}

function deleteState(button_id) {
	if(confirm('Are you sure you want to delete this configuration option?')){
		$('#' + button_id).click();
		timeoutReload('', 0);
	}
}

function setState(state, filters){
	console.log('setting state', state);
	gridOptions.columnApi.applyColumnState({
		state: state,
		applyOrder: true,
	});
	console.log('setting filters', filters);
	if(filters) gridOptions.api.setFilterModel(filters);
}

function saveState(show_saved=true, state_name=null, callback=null) {
	$.ajax({
		url: "<%= save_user_grid_states_path %>",
		method: "PUT",
		data: {
			state_name: state_name,
			state: JSON.stringify(gridOptions.columnApi.getColumnState()),
			filters: JSON.stringify(gridOptions.api.getFilterModel()),
			record_type: "<%= record_type %>",
			authenticity_token: "<%= form_authenticity_token %>",
		},
		success: function() {
			if(show_saved) window.SnackBar({message: "<i class='far fa-save'></i> Configuration saved", position: "tr", dismissible: false, timeout: 2000});
			if(callback != null) callback();
		}
	})
}

function resetState() {
	gridOptions.columnApi.resetColumnState();
	if(typeof additionalReset === 'function') additionalReset();
	saveState(false);
	window.SnackBar({message: "<i class='fa-solid fa-rotate-left'></i> Configuration reset", position: "tr", dismissible: false, timeout: 2000});
}

</script>
