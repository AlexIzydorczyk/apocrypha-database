<div id="manuscripts_grid" class="ag-theme-alpine" style="height: 75vh; width:100%;"></div>

<% manuscripts.each do |manuscript| %>
  <%= button_to "Delete", manuscript_path(manuscript), method: :delete, class: "d-none", id: 'delete_'+manuscript.id.to_s %>
<% end %>

<script type="text/javascript" charset="utf-8">

  const defaultColDef = {editable: true , sortable: true, filter: true,  resizable: true, flex: 1};

  const columnDefs = [
    { headerName: "Census no.", field: "census_no", comparator: numberSort },
    { headerName: "Status", field: "status", cellEditor: 'agRichSelectCellEditor', cellEditorParams: { values: ['extant', 'lost', 'destroyed'] }},
    { headerName: "City", field: "city", editable: false },
    { headerName: "Region", field: "region"},
    { headerName: "Country", field: "country"},
    { headerName: "Repository", field: "institution_id", hide: false, cellEditor: 'agRichSelectCellEditor', cellEditorParams: { values: <%= Institution.pluck(:name_orig).to_json.html_safe %> }, valueGetter: insitutionGetter, valueSetter: insitutionSetter },
    { headerName: "Shelfmark", field: "shelfmark"},
    { headerName: "Old shelfmarks", field: "old_shelfmark"},
    { headerName: "Material", field: "material", hide: true, cellEditor: 'agRichSelectCellEditor', cellEditorParams: { values: ["paper", "parchment", "parchment and paper"] } },
    { headerName: "Dimensions", field: "dimensions", hide: true },
    { headerName: "Number of pages/folios", field: "leaf_page_no", hide: true, comparator: numberSort },
    { headerName: "Date from", field: "date_from", hide: true, comparator: numberSort },
    { headerName: "Date to", field: "date_to", hide: true, comparator: numberSort },
    { headerName: "Content type", field: "content_type", cellEditor: "agRichSelectCellEditor", cellEditorParams: { values: <%= Manuscript.all.pluck(:content_type).uniq.to_json.html_safe %> } },
    { headerName: "Notes", field: "notes", hide: true, cellEditor: 'agLargeTextCellEditor' },
    { headerName: "Languages", field: "languages", hide: true, editable: false },
    { headerName: "Links", field: "links", editable: false, suppressColumnsToolPanel: true, cellRenderer: function(links) {
      return "<a href='" + links.value.edit + "' class='btn btn-outline-secondary btn-sm' target='_blank'>edit</a><a href='#' onclick='if(confirm(\"Are you sure you want to delete this manuscript and all contents including ownerships, booklets, and contents?\")){$("+'"#'+links.value.delete_btn+'"'+").click()}' class='btn btn-outline-danger btn-sm'>delete</a>"
    } }
    ];

    function insitutionGetter(params) {
      return <%= Institution.pluck(:id, :name_orig).to_h.to_json.html_safe %>[params.data.institution_id]
    }
    function insitutionSetter(params) {
      params.data.institution_id = <%= Institution.pluck(:name_orig, :id).to_h.to_json.html_safe %>[params.newValue]
    }

    const rowData = [
    <% manuscripts.each do |manuscript| %>
    { id:<%= manuscript.id %>,
      identifier: "<%= manuscript.identifier %>",census_no: "<%= manuscript.census_no %>",status: "<%= manuscript.status %>",
      institution_id: "<%= manuscript.institution_id %>",
      city: "<%= manuscript.institution.try(:location).try(:city_orig) %>",
      region: "<%= manuscript.institution.try(:location).try(:region_orig) %>",
      country: "<%= manuscript.institution.try(:location).try(:country) %>",
      shelfmark: "<%= manuscript.shelfmark.html_safe %>",
      old_shelfmark: "<%= manuscript.old_shelfmark.html_safe  %>",
      material: "<%= manuscript.material.html_safe  %>",
      dimensions: "<%= manuscript.dimensions.html_safe %>",
      leaf_page_no: "<%= manuscript.leaf_page_no %>",
      date_from: "<%= manuscript.date_from.html_safe  %>",
      date_to: "<%= manuscript.date_to.html_safe  %>",
      content_type: "<%= manuscript.content_type.html_safe %>",
      notes: `<%= manuscript.notes.html_safe  %>`,
      languages: <%= manuscript.languages.pluck(:language_name).to_json.html_safe %>,
      links: { show: "<%= manuscript_path(manuscript) %>", edit: "<%= edit_manuscript_path(manuscript) %>", delete_btn: 'delete_<%= manuscript.id %>' }
    },
    <% end %>
    ];

    const gridOptions = {
      columnDefs: columnDefs,
      defaultColDef: defaultColDef,
      rowData: rowData,
      onCellValueChanged: onCellValueChanged,
      sideBar: 'columns',
    };

    function numberSort(num1, num2){
      return num1 - num2;
    };

    function onCellValueChanged(event){
      saveChange(event.data.id, event.data);
    }

    function saveChange(id, data){
      var my_data = {};
      my_data.in_grid = "1";
      my_data.authenticity_token = "<%= form_authenticity_token %>";
      my_data.manuscript = data;
      $.ajax({
        url: "/manuscripts/"+id,
        type: 'PUT',
        data: JSON.stringify(my_data),
        contentType: 'application/json',
        success: function(data) {
          console.log('result received:');
          console.log(data);
        }
      });
    };

    const eGridDiv = document.querySelector('#manuscripts_grid');
    new agGrid.Grid(eGridDiv, gridOptions);

  </script>
